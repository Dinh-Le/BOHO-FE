<div class="menu-container d-flex align-items-center px-2">
  <span class="fs-14 fw-bold my-text-white">Quản lý camera</span>
  <button type="button" class="ms-auto my-btn-primary" (click)="add()">
    <i class="bi bi-plus me-1"></i>Thêm
  </button>
</div>

<div class="flex-grow-1 flex-basis-0 overflow-y-auto overflow-x-hidden">
  <app-expandable-table
    rowKey="id"
    [data]="data"
    [columns]="columns"
    [collapseContentTemplateRef]="collapseContentTemplate"
  >
  </app-expandable-table>
  <ng-template #collapseContentTemplate let-data="data">
    <div class="row">
      <div class="col-8">
        <ng-container *ngIf="data.isEditable; else readonlyForm">
          <form [formGroup]="data.form" (ngSubmit)="save(data)">
            <div class="row">
              <input
                class="inline-input fs-16 text-white bg-transparent"
                formControlName="name"
              />
            </div>
            <div class="row mt-4">
              <div class="col-4">
                <label [htmlFor]="data.id + '-is-active'">Hoạt động:</label>
              </div>
              <div class="col-8">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    [id]="data.id + '-is-active'"
                    formControlName="is_active"
                  />
                </div>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">
                <label [htmlFor]="data.id + '-driver'">Driver:</label>
              </div>
              <div class="col-8">
                <app-select-2
                  [id]="data.id + '-driver'"
                  formControlName="driver"
                  [items]="cameraDrivers"
                  (ngModelChange)="data.updateCameraForm()"
                ></app-select-2>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Loại:</div>
              <div class="col-8">
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    [id]="data.id + '-camera-type-bullet'"
                    type="radio"
                    formControlName="type"
                    value="Static"
                  />
                  <label
                    class="form-check-label"
                    [htmlFor]="data.id + '-camera-type-bullet'"
                    >Cố định</label
                  >
                </div>
                <div
                  class="form-check form-check-inline"
                  [ngClass]="{
                    'pe-none': data.isRtsp
                  }"
                >
                  <input
                    class="form-check-input"
                    [id]="data.id + '-camera-type-ptz'"
                    type="radio"
                    formControlName="type"
                    value="PTZ"
                    [disabled]="data.isRtsp"
                  />
                  <label
                    class="form-check-label"
                    [htmlFor]="data.id + '-camera-type-ptz'"
                    >PTZ</label
                  >
                </div>
              </div>
            </div>
            <ng-container *ngIf="data.isRtsp">
              <form [formGroup]="data.form.get('camera')">
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-rtsp-url'"
                      >Địa chỉ RTSP:</label
                    >
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-rtsp-url'"
                      formControlName="rtspUrl"
                      class="form-control bg-transparent border-light"
                      required
                      placeholder="[RTSP URL]"
                    />
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-rtsp-user-id'"
                      >ID người dùng:</label
                    >
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-rtsp-user-id'"
                      formControlName="userId"
                      class="form-control bg-transparent border-light"
                      placeholder="[ID người dùng]"
                    />
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-rtsp-user-password'"
                      >Mật khẩu:</label
                    >
                  </div>
                  <div class="col-8">
                    <password-input
                      [id]="data.id + '-rtsp-user-password'"
                      formControlName="password"
                      class="w-100"
                      placeHolder="[********]"
                    ></password-input>
                  </div>
                </div>
              </form>
            </ng-container>
            <ng-container *ngIf="data.isOnvif">
              <form [formGroup]="data.form.get('camera')">
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-ip'">IP:</label>
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-onvif-ip'"
                      formControlName="ip"
                      class="form-control bg-transparent border-light"
                      required
                      placeholder="[IP]"
                    />
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-port'">Cổng:</label>
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-onvif-port'"
                      type="number"
                      min="1"
                      max="65535"
                      formControlName="httpPort"
                      class="form-control bg-transparent border-light"
                      required
                      placeholder="[cổng]"
                    />
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-user-id'"
                      >ID người dùng:</label
                    >
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-onvif-user-id'"
                      formControlName="userId"
                      class="form-control bg-transparent border-light"
                      required
                      placeholder="[ID người dùng]"
                    />
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-password'"
                      >Mật khẩu:</label
                    >
                  </div>
                  <div class="col-8">
                    <password-input
                      [id]="data.id + '-onvif-password'"
                      formControlName="password"
                      class="w-100"
                      placeHolder="[********]"
                    ></password-input>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="offset-4 col-auto">
                    <button
                      type="button"
                      class="connect-button"
                      (click)="getOnvifProfiles($event, data)"
                    >
                      Kết nối
                    </button>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-profile'"
                      >Profile:</label
                    >
                  </div>
                  <div class="col-8">
                    <app-select-2
                      formControlName="profile"
                      [items]="data.onvifProfiles"
                      placeHolder="Chọn profile"
                    ></app-select-2>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-onvif-rtsp-url'"
                      >Địa chỉ RTSP:</label
                    >
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-onvif-rtsp-url'"
                      formControlName="rtspUrl"
                      class="form-control bg-transparent border-light"
                      required
                      readonly
                      placeholder="[RTSP URL]"
                    />
                  </div>
                </div>
              </form>
            </ng-container>
            <ng-container *ngIf="data.isMilestone">
              <form [formGroup]="data.form.get('camera')">
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-milestone-server'"
                      >Máy chủ:</label
                    >
                  </div>
                  <div class="col-8">
                    <app-select-2
                      [items]="milestoneServers"
                      formControlName="server"
                      required
                      placeHolder="Chọn máy chủ"
                    ></app-select-2>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-milestone-camera'"
                      >Camera:</label
                    >
                  </div>
                  <div class="col-8">
                    <app-select-2
                      [items]="milestoneCameras"
                      formControlName="camera"
                      required
                      placeHolder="Chọn camera"
                    ></app-select-2>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-4">
                    <label [htmlFor]="data.id + '-milestone-rtsp-url'"
                      >Địa chỉ RTSP:</label
                    >
                  </div>
                  <div class="col-8">
                    <input
                      [id]="data.id + '-milestone-rtsp-url'"
                      formControlName="rtspUrl"
                      class="form-control bg-transparent border-light"
                      required
                      placeholder="[RTSP URL]"
                    />
                  </div>
                </div>
              </form>
            </ng-container>
            <div class="row mt-2">
              <div class="col-4">Nhóm camera:</div>
              <div class="col-8">
                <app-select-2
                  formControlName="group"
                  [items]="groups"
                  placeHolder="Chọn nhóm camera"
                ></app-select-2>
              </div>
            </div>
            <div class="row mt-4">
              <div class="d-flex justify-content-end">
                <button
                  type="button"
                  class="my-button cancel mx-1"
                  (click)="cancel(data)"
                >
                  Hủy
                </button>
                <button
                  class="my-button submit mx-1"
                  [disabled]="!data.canSubmit"
                >
                  Lưu
                </button>
              </div>
            </div>
          </form>
        </ng-container>
        <ng-template #readonlyForm>
          <div class="row">
            <span class="fs-16 text-white col-auto">{{ data.name }}</span>
          </div>
          <div class="row mt-4">
            <div class="col-4">Hoạt động:</div>
            <div class="col-8">
              <i
                class="bi"
                [ngClass]="data.isActive ? 'bi-check-lg' : 'bi-x'"
              ></i>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-4">Driver:</div>
            <div class="col-8">
              {{ data.driver }}
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-4">Loại:</div>
            <div class="col-8">
              {{ data.type }}
            </div>
          </div>
          <ng-container *ngIf="data.isRtsp">
            <div class="row mt-2">
              <div class="col-4">Địa chỉ RTSP:</div>
              <div class="col-8">
                {{ data.rtspUrl }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">ID người dùng:</div>
              <div class="col-8">
                {{ data.userId }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Mật khẩu:</div>
              <div class="col-8">
                {{ data.password | mask }}
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="data.isOnvif">
            <div class="row mt-2">
              <div class="col-4">IP:</div>
              <div class="col-8">
                {{ data.ip }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Cổng:</div>
              <div class="col-8">
                {{ data.httpPort }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">ID người dùng:</div>
              <div class="col-8">
                {{ data.userId }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Mật khẩu:</div>
              <div class="col-8">
                {{ data.password | mask }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Profile:</div>
              <div class="col-8">
                {{ data.onvifProfileName }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Địa chỉ RTSP:</div>
              <div class="col-8">
                {{ data.rtspUrl }}
              </div>
            </div>
          </ng-container>
          <ng-container *ngIf="data.isMilestone">
            <div class="row mt-2">
              <div class="col-4">Máy chủ:</div>
              <div class="col-8">
                {{ data.form.get("subForm.server").value }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Camera:</div>
              <div class="col-8">
                {{ data.form.get("subForm.camera").value }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Địa chỉ RTSP:</div>
              <div class="col-8">
                {{ data.form.get("subForm.rtspUrl").value }}
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-4">Nhóm camera:</div>
              <div class="col-8">
                {{ data.group?.label }}
              </div>
            </div>
          </ng-container>
          <div class="row mt-4">
            <div class="d-flex justify-content-end">
              <button
                type="button"
                class="btn btn-danger px-4 mx-1 text-white"
                (click)="remove(data)"
              >
                Xóa
              </button>
              <button
                type="submit"
                class="btn btn-primary px-4 mx-1 text-white"
                (click)="data.isEditable = true"
              >
                Chỉnh sửa
              </button>
            </div>
          </div>
        </ng-template>
      </div>
      <div class="col-4 d-flex justify-content-center align-items-center">
        <div
          class="position-relative d-flex align-items-center justify-content-center"
          style="width: 70%; aspect-ratio: 16/9; background: black"
        >
          <img #snapshot alt="Hình ảnh camera" class="mw-100 mh-100" />
          <button
            class="position-absolute top-0 end-0 bg-transparent border-0"
            (click)="takeSnapshot(data, snapshot)"
          >
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template #statusColumnTemplate let-row="row">
    <container-element [ngSwitch]="row.status">
      <span class="px-2 device-status bg-good" *ngSwitchCase="'ONLINE'">
        {{ row.status | translate }}
      </span>
      <span class="px-2 device-status bg-error" *ngSwitchCase="'FAIL'">
        {{ row.status | translate }}
      </span>
      <span class="px-2 device-status bg-disconnected" *ngSwitchDefault>
        {{ row.status | translate }}
      </span>
    </container-element>
  </ng-template>
</div>
